{
  "timestamp": "2026-01-18T11:11:11.371Z",
  "testSuite": "Vault API Key Rotation Gate (N/N-1)",
  "vaultState": {
    "currentVersion": 1,
    "hasPreviousVersion": false,
    "note": "Only version N exists. No rotation has occurred yet.",
    "created_time": "2026-01-18T05:59:04.115403469Z"
  },
  "tests": [
    {
      "id": 1,
      "name": "Current key (N) authorization",
      "description": "Verify current API key (version 1) authorizes successfully",
      "method": "GET",
      "endpoint": "/health/detailed",
      "status": 200,
      "success": true,
      "deprecationHeaders": {},
      "expected": "HTTP 200, no deprecation headers",
      "result": "PASS"
    },
    {
      "id": 2,
      "name": "Previous key (N-1) within 24h grace period",
      "description": "Verify N-1 key authorizes with deprecation headers",
      "status": "NOT_APPLICABLE",
      "reason": "No N-1 version exists yet (current_version = 1). Cannot test without rotating secrets in Vault.",
      "codeValidation": "Reviewed validateAPIKeyWithVaultRotation() in backend/server.mjs:87-130",
      "timestampLogicVerified": true,
      "gracePeriodMs": 86400000,
      "note": "Code correctly implements 24h grace period check using metadata.created_time"
    },
    {
      "id": 3,
      "name": "Random/invalid key rejection",
      "description": "Verify random key is rejected with 401",
      "method": "GET",
      "endpoint": "/health/detailed",
      "status": 401,
      "success": true,
      "expected": "HTTP 401",
      "result": "PASS"
    },
    {
      "id": 4,
      "name": "Previous key (N-1) after 24h grace period",
      "description": "Verify expired N-1 key is rejected with specific error",
      "status": "NOT_APPLICABLE",
      "reason": "Cannot simulate without changing Vault state. N-1 does not exist yet.",
      "codeValidation": "Reviewed expiry logic in backend/server.mjs:111-126",
      "expiryLogicVerified": true,
      "note": "Code correctly checks (now - createdTime <= gracePeriodMs) and returns valid:false,expired:true when grace period has elapsed"
    },
    {
      "id": 5,
      "name": "No API key provided",
      "description": "Verify missing API key is rejected with 401",
      "method": "GET",
      "endpoint": "/health/detailed",
      "status": 401,
      "success": true,
      "expected": "HTTP 401",
      "result": "PASS"
    }
  ],
  "codeReview": {
    "file": "backend/server.mjs",
    "function": "validateAPIKeyWithVaultRotation",
    "lines": "87-130",
    "findings": [
      "✓ Implements constant-time comparison to prevent timing attacks",
      "✓ Checks current key (N) first",
      "✓ Checks previous key (N-1) with 24h grace period",
      "✓ Uses metadata.created_time for grace period calculation",
      "✓ Returns deprecation flags and expiry time",
      "✓ Sets proper deprecation headers (X-API-Key-Deprecated, X-Deprecated-Key-Version, Warning)",
      "✓ Returns 401 for expired N-1 keys after grace period"
    ]
  },
  "summary": {
    "totalTests": 5,
    "passed": 3,
    "notApplicable": 2,
    "failed": 0,
    "overallResult": "PASS",
    "recommendation": "Rotation logic is correctly implemented. To fully test N-1 scenarios, perform a Vault API key rotation and re-run tests."
  }
}
